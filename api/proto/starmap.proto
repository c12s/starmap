syntax = "proto3";

option go_package="github.com/c12s/starmap/api";
package proto;

import "starmap_model.proto";

service RegistryService{
    rpc PutChart(StarChart) returns(PutChartResp){}
    rpc GetChartMetadata(GetChartFromMetadataReq) returns(GetChartResp){}
    rpc GetChartsLabels(GetChartsLabelsReq) returns(GetChartsLabelsResp){}
    rpc GetChartId(GetChartIdReq) returns(GetChartResp){}
    rpc GetMissingLayers(GetMissingLayersReq) returns(GetMissingLayersResp){}
    rpc DeleteChart(DeleteChartReq) returns(EmptyMessage){}
    rpc UpdateChart(StarChart) returns(PutChartResp){}
    rpc SwitchCheckpoint(SwitchCheckpointReq) returns(SwitchCheckpointResp){}
    rpc Timeline(TimelineReq) returns(TimelineResp){} 
}

message TimelineReq {
  string chartId = 1;
  string namespace = 2;
  string maintainer = 3;
}

message TimelineResp {
  repeated GetChartResp charts = 1;
}

message SwitchCheckpointResp {
  LayersResp start = 1;
  LayersResp stop = 2;
  LayersResp download = 3;
}

message SwitchCheckpointReq {
  string chartId = 1;
  string namespace = 2;
  string maintainer = 3;
  string oldVersion = 4;
  string newVersion = 5;
  repeated string layers = 6;
} 

message LayersResp {
  map<string, DataSource> dataSources = 1;
  map<string, StoredProcedure> storedProcedures = 2;
  map<string, EventTrigger> eventTriggers = 3;
  map<string, Event> events = 4;
}

message GetMissingLayersReq {
  string schemaVersion = 1;
  string chartId = 2;
  string namespace = 3;
  string maintainer = 4;
  repeated string layers = 5;
}

message GetMissingLayersResp {
  string chartId = 1;
  string namespace = 2;
  string maintainer = 3;
  string apiVersion = 4;
  string schemaVersion = 5;
  map<string, DataSource> dataSources = 6;
  map<string, StoredProcedure> storedProcedures = 7;
  map<string, EventTrigger> eventTriggers = 8;
  map<string, Event> events = 9;
}

message GetChartIdReq {
  string schemaVersion = 1;
  string chartId = 2;
  string namespace = 3;
  string maintainer = 4;
}

message DeleteChartReq {
  string id = 1;
  string name = 2;
  string namespace = 3;
  string maintainer = 4;
  string schemaVersion = 5;
  string kind = 6;
}

message GetChartsLabelsReq {
  string schemaVersion = 1;
  string namespace = 2;
  string maintainer = 3;
  map<string, string> labels = 4;
}

message GetChartsLabelsResp {
  repeated GetChartResp charts = 1;
}

message GetChartFromMetadataReq {
  string name = 1;
  string namespace = 2;
  string maintainer = 3;
  string schemaVersion = 4;
}

message GetChartResp {
  string apiVersion = 1;
  string schemaVersion = 2;
  MetadataChart metadata = 3;
  Chart chart = 4;
}

message PutChartResp {
  string id = 1;
  string apiVersion = 2;
  string schemaVersion = 3;
  string kind = 4;
  string name = 5;
  string namespace = 6;
  string maintainer = 7;
}